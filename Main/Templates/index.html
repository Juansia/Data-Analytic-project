<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commodity Price Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }
        .prediction-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .prediction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .commodity-icon {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-chart-line text-2xl"></i>
                    <h1 class="text-2xl font-bold">Commodity Price Predictor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <select id="commodity-select" class="bg-blue-800 text-white px-4 py-2 rounded-lg appearance-none pr-8">
                            <option value="brent">Brent Crude Oil</option>
                            <option value="sugar">Sugar</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Current Price Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Current Market Data - <span id="commodity-name" class="text-blue-600">Brent Crude Oil</span></h2>
                <div class="text-sm text-gray-500">Last updated: <span id="last-updated">Just now</span></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-blue-600 font-medium">Current Price</p>
                            <p class="text-2xl font-bold text-gray-800" id="current-price">$--.--</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full commodity-icon" id="price-icon">
                            <i class="fas fa-oil-can text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-green-600 font-medium">24h Change</p>
                            <p class="text-2xl font-bold text-gray-800" id="daily-change">+--.--%</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-arrow-up text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-purple-600 font-medium">Market Sentiment</p>
                            <p class="text-2xl font-bold text-gray-800" id="sentiment">Neutral</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-balance-scale text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Predictions Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Daily Price Predictions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Day 1 Prediction -->
                <div class="prediction-card bg-white border border-gray-200 rounded-xl p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-800">Day 1</h3>
                            <p class="text-sm text-gray-500">Tomorrow's prediction</p>
                        </div>
                        <div class="bg-blue-100 p-2 rounded-lg">
                            <i class="fas fa-calendar-day text-blue-600"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-3xl font-bold text-gray-800" id="prediction-day1">$--.--</p>
                        <p class="text-sm text-gray-500 flex items-center" id="change-day1">
                            <span class="inline-flex items-center">
                                <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                                <span>+--.--%</span>
                            </span>
                        </p>
                    </div>
                    <div class="text-xs text-gray-400" id="date-day1">
                        <!-- Date will be inserted here -->
                    </div>
                </div>

                <!-- Day 2 Prediction -->
                <div class="prediction-card bg-white border border-gray-200 rounded-xl p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-800">Day 2</h3>
                            <p class="text-sm text-gray-500">2 days ahead</p>
                        </div>
                        <div class="bg-green-100 p-2 rounded-lg">
                            <i class="fas fa-calendar-plus text-green-600"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-3xl font-bold text-gray-800" id="prediction-day2">$--.--</p>
                        <p class="text-sm text-gray-500 flex items-center" id="change-day2">
                            <span class="inline-flex items-center">
                                <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                                <span>+--.--%</span>
                            </span>
                        </p>
                    </div>
                    <div class="text-xs text-gray-400" id="date-day2">
                        <!-- Date will be inserted here -->
                    </div>
                </div>

                <!-- Day 3 Prediction -->
                <div class="prediction-card bg-white border border-gray-200 rounded-xl p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-800">Day 3</h3>
                            <p class="text-sm text-gray-500">3 days ahead</p>
                        </div>
                        <div class="bg-purple-100 p-2 rounded-lg">
                            <i class="fas fa-calendar-week text-purple-600"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-3xl font-bold text-gray-800" id="prediction-day3">$--.--</p>
                        <p class="text-sm text-gray-500 flex items-center" id="change-day3">
                            <span class="inline-flex items-center">
                                <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                                <span>+--.--%</span>
                            </span>
                        </p>
                    </div>
                    <div class="text-xs text-gray-400" id="date-day3">
                        <!-- Date will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Data Chart -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Historical Price & 3-Day Predictions</h2>
            <div class="h-96">
                <canvas id="historical-chart"></canvas>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="flex justify-center mb-4">
                <div class="loading-spinner"></div>
            </div>
            <h3 class="text-lg font-medium text-gray-800 mb-2">Fetching Predictions</h3>
            <p class="text-gray-600">Connecting to prediction engine...</p>
        </div>
    </div>

    <script>
        // Global variables
        let currentCommodity = 'brent';
        let historicalChart;
        
        // DOM Elements
        const commoditySelect = document.getElementById('commodity-select');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadingModal = document.getElementById('loading-modal');
        const commodityName = document.getElementById('commodity-name');
        const priceIcon = document.getElementById('price-icon');
        
        // Price display elements
        const currentPriceEl = document.getElementById('current-price');
        const dailyChangeEl = document.getElementById('daily-change');
        const sentimentEl = document.getElementById('sentiment');
        const lastUpdatedEl = document.getElementById('last-updated');
        
        // Prediction elements for each day
        const predictionDay1El = document.getElementById('prediction-day1');
        const changeDay1El = document.getElementById('change-day1');
        const dateDay1El = document.getElementById('date-day1');
        
        const predictionDay2El = document.getElementById('prediction-day2');
        const changeDay2El = document.getElementById('change-day2');
        const dateDay2El = document.getElementById('date-day2');
        
        const predictionDay3El = document.getElementById('prediction-day3');
        const changeDay3El = document.getElementById('change-day3');
        const dateDay3El = document.getElementById('date-day3');
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize chart
            initializeChart();
            
            // Load initial data
            fetchPredictions();
            
            // Set up event listeners
            commoditySelect.addEventListener('change', (e) => {
                currentCommodity = e.target.value;
                updateCommodityDisplay();
                fetchPredictions();
            });
            
            refreshBtn.addEventListener('click', fetchPredictions);
        });
        
        // Update commodity display
        function updateCommodityDisplay() {
            const displayName = currentCommodity === 'brent' ? 'Brent Crude Oil' : 'Sugar';
            commodityName.textContent = displayName;
            
            // Update icon
            if (currentCommodity === 'brent') {
                priceIcon.innerHTML = '<i class="fas fa-oil-can text-blue-600 text-xl"></i>';
            } else {
                priceIcon.innerHTML = '<i class="fas fa-cube text-blue-600 text-xl"></i>';
            }
        }
        
        // Initialize the historical chart
        function initializeChart() {
            const historicalCtx = document.getElementById('historical-chart').getContext('2d');
            historicalChart = new Chart(historicalCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Historical Prices',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '3-Day Predictions',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{
                            gridLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }],
                        yAxes: [{
                            gridLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }]
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, chart) {
                                return 'Price: $' + tooltipItem.yLabel.toFixed(2);
                            }
                        }
                    }
                }
            });
        }
        
        // Fetch predictions from API
        async function fetchPredictions() {
            showLoading();
            
            try {
                // Fetch 3-day prediction which contains all individual day predictions
                const response = await fetchPredictionForPeriod(3);
                
                // Update current price section
                updateCurrentPriceSection(response);
                
                // Get the correct price key based on commodity
                const priceKey = currentCommodity === 'brent' 
                    ? 'Predicted_BRENT_Price' 
                    : 'Predicted_SUGAR_Price';
                
                // Get the last known price for change calculations
                const lastKnownPrice = response.statistics.last_known_price;
                
                // Extract predictions for each day
                const predictions = response.predictions.map(item => parseFloat(item[priceKey]));
                
                // Debug logging
                console.log('3-day predictions:', predictions);
                console.log('Last known price:', lastKnownPrice);
                
                // Update Day 1 prediction
                if (predictions[0]) {
                    const change1 = ((predictions[0] - lastKnownPrice) / lastKnownPrice) * 100;
                    updateDayPrediction('day1', predictions[0], change1, 1);
                }
                
                // Update Day 2 prediction
                if (predictions[1]) {
                    const change2 = ((predictions[1] - lastKnownPrice) / lastKnownPrice) * 100;
                    updateDayPrediction('day2', predictions[1], change2, 2);
                }
                
                // Update Day 3 prediction
                if (predictions[2]) {
                    const change3 = ((predictions[2] - lastKnownPrice) / lastKnownPrice) * 100;
                    updateDayPrediction('day3', predictions[2], change3, 3);
                }
                
                // Update the historical chart with only 3-day predictions
                updateHistoricalChart(
                    response.historical ? response.historical.map(item => item.price) : [],
                    predictions
                );
                
                // Update last updated time
                lastUpdatedEl.textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error fetching predictions:', error);
                alert('Failed to fetch predictions. Please try again.');
                
                // Fallback to mock data if API call fails
                const mockData = generateMockData(currentCommodity);
                updateUIWithMockData(mockData);
            } finally {
                hideLoading();
            }
        }
        
        // Helper function to fetch prediction for a specific time period
        async function fetchPredictionForPeriod(days) {
            console.log(`Fetching ${days}-day prediction for ${currentCommodity}`);
            
            const response = await fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `days=${days}&commodity=${currentCommodity}`
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`API error for ${days}-day prediction:`, errorText);
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        // Update current price section
        function updateCurrentPriceSection(data) {
            // Update current market data
            currentPriceEl.textContent = `$${data.statistics.last_known_price.toFixed(2)}`;
            
            // Update the daily change display
            const changeValue = data.statistics.price_change_percent;
            dailyChangeEl.innerHTML = changeValue >= 0 
                ? `<span class="inline-flex items-center"><i class="fas fa-arrow-up text-green-500 mr-1"></i><span>+${Math.abs(changeValue).toFixed(2)}%</span></span>` 
                : `<span class="inline-flex items-center"><i class="fas fa-arrow-down text-red-500 mr-1"></i><span>-${Math.abs(changeValue).toFixed(2)}%</span></span>`;
            
            // Update sentiment
            sentimentEl.textContent = data.statistics.price_change_percent >= 0 ? 'Bullish' : 'Bearish';
            sentimentEl.className = `text-2xl font-bold ${
                data.statistics.price_change_percent >= 0 ? 'text-green-600' : 'text-red-600'
            }`;
        }
        
        // Update individual day prediction
        function updateDayPrediction(dayId, price, change, daysAhead) {
            const priceEl = document.getElementById(`prediction-${dayId}`);
            const changeEl = document.getElementById(`change-${dayId}`);
            const dateEl = document.getElementById(`date-${dayId}`);
            
            // Update price
            if (priceEl) {
                priceEl.textContent = `$${price.toFixed(2)}`;
            }
            
            // Update change
            if (changeEl) {
                const icon = change >= 0 ? 
                    '<i class="fas fa-arrow-up text-green-500 mr-1"></i>' : 
                    '<i class="fas fa-arrow-down text-red-500 mr-1"></i>';
                
                changeEl.innerHTML = `<span class="inline-flex items-center">
                    ${icon}
                    <span>${change >= 0 ? '+' : '-'}${Math.abs(change).toFixed(2)}%</span>
                </span>`;
            }
            
            // Update date
            if (dateEl) {
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + daysAhead);
                dateEl.textContent = futureDate.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
        }
        
        // Update the historical chart
        function updateHistoricalChart(historicalData, predictionsData) {
            // Generate labels for historical data (negative days)
            const historicalLabels = historicalData.map((_, i) => `Day ${i - historicalData.length + 1}`);
            
            // Generate labels for predictions (Day 1, Day 2, Day 3)
            const predictionLabels = ['Day 1', 'Day 2', 'Day 3'];
            
            // Combine all labels
            const labels = historicalLabels.concat(predictionLabels);
            
            // Prepare data for historical line (with null values for predictions)
            const historicalChartData = historicalData.concat(Array(3).fill(null));
            
            // Prepare data for predictions line (with null values for historical, then actual predictions)
            const predictionChartData = Array(historicalData.length).fill(null).concat(predictionsData);
            
            // Update the chart
            historicalChart.data.labels = labels;
            historicalChart.data.datasets[0].data = historicalChartData;
            historicalChart.data.datasets[1].data = predictionChartData;
            historicalChart.update();
        }
        
        // Show loading modal
        function showLoading() {
            loadingModal.classList.remove('hidden');
        }
        
        // Hide loading modal
        function hideLoading() {
            loadingModal.classList.add('hidden');
        }
        
        // Update UI with mock data (fallback)
        function updateUIWithMockData(data) {
            // Update current price section
            currentPriceEl.textContent = `$${data.current_price.toFixed(2)}`;
            
            // Update daily change
            dailyChangeEl.innerHTML = data.daily_change >= 0 
                ? `<span class="inline-flex items-center"><i class="fas fa-arrow-up text-green-500 mr-1"></i><span>+${Math.abs(data.daily_change).toFixed(2)}%</span></span>` 
                : `<span class="inline-flex items-center"><i class="fas fa-arrow-down text-red-500 mr-1"></i><span>-${Math.abs(data.daily_change).toFixed(2)}%</span></span>`;
            
            // Update sentiment
            sentimentEl.textContent = data.sentiment;
            sentimentEl.className = `text-2xl font-bold ${data.sentiment === 'Bullish' ? 'text-green-600' : 'text-red-600'}`;
            
            // Update day predictions
            data.predictions.forEach((prediction, index) => {
                const dayId = `day${index + 1}`;
                const change = ((prediction - data.current_price) / data.current_price) * 100;
                updateDayPrediction(dayId, prediction, change, index + 1);
            });
            
            // Update historical chart
            updateHistoricalChart(data.historical, data.predictions);
        }
        
        // Generate mock data for testing
        function generateMockData(commodity) {
            const basePrice = commodity === 'brent' ? 85.0 : 20.0;
            const change = (Math.random() * 5) - 2.5; // Random change between -2.5% and +2.5%
            
            return {
                commodity: commodity,
                current_price: basePrice,
                daily_change: change,
                sentiment: change >= 0 ? 'Bullish' : 'Bearish',
                historical: Array(30).fill().map((_, i) => basePrice - 10 + Math.random() * 20),
                predictions: [
                    basePrice * (1 + change/300),      // Day 1
                    basePrice * (1 + change/200),      // Day 2
                    basePrice * (1 + change/100)       // Day 3
                ]
            };
        }
    </script>
</body>
</html>
